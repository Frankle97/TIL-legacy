# 프로그램 구조와 실행

## 프로그램의 구조와 인터럽트
CPU가 명령을 수행하기 위해선 메모리에 올라가 있는 프로그램의 주소 영역을 알아야하고 크게 **코드**, **데이터**, **스택**으로 구분된다.

- 코드 영역
  - 프로그램 함수들의 코드가 CPU에서 수행할 수 있는 기계어 명령어 형태로 변환되어 저장된 부분
- 데이터 영역
  - 전역 변수 등 프로그램이 사용하는 데이터를 저장하는 부분
- 스택 영역
  - 함수가 호출될 때 호출된 함수의 수행을 마치고 복귀할 주소 및 임시 데이터를 저장하는 부분

일반적으로 프로그램에서 발생했던 함수 호출에 복귀 주소는 각 프로그램의 스택 영역에 보관하는 반면 인터럽트로 인해 CPU를 빼앗긴 위치는 PCB에 저장이 된다.

## 컴퓨터 시스템 작동의 개요
CPU는 매우 빠른 처리 속도를 갖고 있지만, 무엇을 처리해야 하는지 스스로 판단하는 지성을 갖추고 있지는 않다.
그저 매 시점에 특정한 경우가(반복문, 조건문)아니라면 **프로그램 카운터**(메모리 주소를 담는 레지스터)에서 명령을 하나씩 읽어와 실행할 뿐이다.

입출력 장치마다 존재하는 작은 CPU와 메모리를 각각 **입출력 컨트롤러**와 **로컬버퍼**라고 부른다.

CPU가 수행하는 명령에는 일반명령과 특권명령으로 나뉜다.
- 일반 명령
  - 모든 프로그램이 수행할 수 있는 명령
- 특권명령
  - 입출력 장치, 타이머 등 각종 장치에 접근하듯 보안이 필요한 명령

컴퓨터 시스템에는 특권명령은 항상 운영체제만이 수행할 수 있도록 제한하고 있으며, 둘의 구분은 CPU 내의 모드비트를 활용한다.

사용자 프로그램이 일반명령 외에 특권명령의 사용이 필요한 경우 운영체제에 특권명령 대행을 요청하는데, 이를 **시스템 콜**이라고 부른다.<br/>
시스템 콜이 오면 운영체제가 사용자 프로그램 코드가 아닌 자신의 커널 영역에 정의된 시스템 콜 처리 코드를 수행한다.

CPU는 주변 장치 상태를 지속하여 파악할 수 없으므로 주변 장치가 CPU의 도움이 필요한 경우 인터럽트로 도움을 요청한다.
인터럽트를 발생시키기 위해 주변장치는 인터럽트 라인을 세팅하고, CPU는 매번 명령을 수행한 직후 인터럽트 라인을 체크하여 서비스 요청이 들어왔는지를 확인한다.

## 프로그램의 실행
프로그램이 실행된다는 것은 디스크에 존재하던 실행파일이 메모리에 적재된다는 의미와 프로그램이 CPU를 할당받고 명령을 수행하고 있다는 의미이다.

프로그램이 실행되어 메모리에 올라갈 때, 전체를 올리는 것이 아닌 메모리를 효율적으로 사용하기 위해 꼭 필요한 부분만 올린다. 
구체적으로는 당장 CPU 수행에 필요하지 않은 부분은 메모리가 아닌 디스크의 메모리 연장 영역으로 사용되는 **스왑 영역**에 놓는 방식으로 운영된다.

## 사용자 프로그램이 사용하는 함수
일반적인 함수호출이 사용자 프로그램 내의 코드를 실행하는 것이라면, 시스템 콜은 운영체제 프로그램의에 CPU를 넘겨서 실행하는 것이다.

## 인터럽트
인터럽트 중에 또 다른 인터럽트가 발생할 수 있기 때문에 인트럽트마다의 우선순위를 가질 수 있고, 우선순위가 높은 인터럽트부터 먼저 처리한다.

## 시스템 콜
모든 프로그램은 독자적인 주소를 갖고 함수 호출을 하는 경우 자신의 주소 공간 내에서 호출이 이루어지게 된다.
하지만 **시스템 콜**은 함수 호출이긴 하지만 자신의 영역이 아닌 커널 영역에 함수를 호출한다.

프로그램이 CPU를 할당받고 명령 수행 도중 CPU를 뺏기는 경우는 **타이머에 의해 인터럽트 발생** 또는 **입출력 요청을 위해 시스템 콜** 하는 경우가 있다.

타이머는 특정 프로그램에 의해 CPU 독점을 방지하기 위한 하드웨어로, CPU 할당시간이 만료되면 인터럽트를 발생시킨다.
이러한 타이머는 CPU의 시분할 시스템 구현을 위한 필수적인 요소라고 볼 수 있다.


## 프로세스의 두 가지 실행 상태
프로세스 수행을 시작하면 프로세스 자신의 코드만 실행되는 것이 아니라 커널 주소 공간의 코드도 실행된다.
이는 프로그램이 사용자 정의함수나 라이브러리 함수뿐만 아니라 입출력 시스템 콜을 통해 운영체제 커널의 함수도 호출하여 실행하기 때문이다.

자신의 주소 공간에 정의된 코드를 실행하는 것을 **사용자 모드의 실행 상태(user mode running)** 라고 하고, 커널의 코드 실행을 **커널모드에서의 실행 상태(kernel mod running)** 라고 한다.

정리하자면 프로그램은 시작부터 종료까지 다양한 함수 호출을 하는데, 이를 **사용자 모드**와 **커널 모드**로 구분 지을 수 있다.
시스템 콜을 하면 커널 모드로 진입해 커널 주소 공간의 함수를 실행하고, 시스템 콜 실행이 끝나면 다시 사용자 모드로 복귀한다.
프로그램 실행이 끝날 때에는 커널 모드로 진입하여 프로그램을 종료한다.