# 트랜잭션과 동시성 제어
## 트랜잭션
- **트랜잭션**은 복수의 쿼리를 일관성있는 한 단위로 취급해야 하며, 이러한 **한 묶음의 쿼리 처리 단위**를 말한다.
- 트랜잭션은 다음 4가지 특성으로 정의되며, ***ACID*** 특성이라고도 불린다.
  - **Atomicity** *(원자성)*
  - **Consistency** *(일관성)*
  - **Isolation** *(고립성 또는 격리성)*
  - **Durability** *(지속성)*

### 원자성 (Atomicity)
- **원자성**은 데이터의 변경 쿼리들이 전부 성공 또는 실패할지를 말한다.
- 예를 들어, 4단계(쿼리)로 묶여진 트랜잭션이 진행 중에 어떠한 이유로 문제가 발생했다면, 처음 상태로 돌아간다. `(ROLLBACK)`
- 만약, 4단계 모두 성공적으로 마무리가 됐다면 `COMMIT`하여 처리를 확정한다.

### 일관성 (Consistency)
- **일관성**은 PK, UK 등의 장치를 이용하여 일련의 데이터 조작 전후에 **그 상태를 유지됨을 보증**하는 것을 말한다.

### 고립성(격리성) (Isolation)
- **고립성**은 데이터 조작을 복수의 사용자가 동시에 실행하더라도 **각각의 처리가 모순 없이** 실행되는 것을 말한다.
  - 모순이 없다는 것은, **복수의 트랜잭션이 순서대로 실행되는 경우 동일한 결과를 얻을 수 있다**는 것을 의미한다.
- 데이터 정합성을 위해 테이블에 `잠금`을 걸어 후속 처리를 `블록`하는 방법이 있다.
  - 잠금 단위에는 테이블 전체, 블록, 행 등이 있는데, MySQL은 트랜잭션 처리에서 주로 행 잠금 기능을 이용한다.

- 이는 DBMS에서 *격리 수준*으로 구현하고 제공하는 것이 **직렬화 가능**이라는 사양이다.
- 하지만, **직렬화 가능의 고립성은 성능면에서 실용적이지 않다.**
- 이 때문에 **직렬화 가능 외에 자신이 아닌 다른 트랜잭션의 영항을 받음을 허용하는 4단계**를 **ANSI**에서 정의했다.
- ***ANSI 격리 수준***
  - **커밋되지 않은 읽기** *(Read Uncommitted)*
  - **커밋된 읽기** *(Read Committed)*
  - **반복 읽기** *(Repeatable Read)*
  - **직렬화 가능** *(Serializable)*
    - 가장 엄격하다.
- 위로 갈수록 완화되어, 커밋되지 않은 읽기가 가장 완화된 격리 수준이다.


- **격리 수준 완화에 따라 일어나는 현상**

| 더티 읽기(Dirty Read)                     | 애매한 읽기(NonRepeatable Read)                          | 팬텀 읽기(Phantom Read)                    |
|---------------------------------------|-----------------------------------------------------|----------------------------------------|
| 어떤 트랜잭션이 커밋되기 전에 다른 트랜잭션에서 데이터를 읽는 현상 | 어떤 트랜잭션이 이전에 읽었던 데이터를 다시 읽을 때, 2회 이후의 결과와 처음과 다른 현상 | 어떤 트랜잭션을 읽을 때 선택 가능한 데이터가 보였다가 사라지는 현상 |

- **위 현상과 격리 수준과의 관계**

| 격리 수준      | 더티 읽기 | 애매한 읽기 | 팬텀 읽기 |
|------------|-------|--------|-------|
| 커밋되지 않은 읽기 | O     | O      | O     |
| 커밋된 읽기     | X     | O      | O     |
| 반복 읽기      | X     | X      | O     |
| 직렬화 가능     | X     | X      | X     |

### 지속성 (Durability)
- **지속성**은 일련의 데이터 조작(*트랜잭션*)을 완료(`COMMIT`)하고 사용자가 받는 조작이 영구적이며, 결과를 잃지 않는 것을 나타낸다. 
- 이는 시스템 정상, 비정상, OS 종료 등의 시스템 장애애도 견딜 수 있다는 의미이기도 하다.
  - MySQL을 비롯해 많은 데이터베이스들은 트랜잭션의 조작을 **하드 디스크에 로그로 저장**하고, 시스템 이상이 발생하면 로그를 사용해 **이상 발생 시점 이전으로 복원이 가능**하다.
